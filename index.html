<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
	<style>
	    body {
		  font-family: Georgia;
		}
		
		h2 {
		  color: black;
		  text-align: left;
		  padding: 20px;
		}
		
		table.button {
			position: fixed;
			top: 70px;
			left: 800px;
		}

		table.button tr td {
			background-color: rgb(251, 201, 127);
			padding: 3px;
			margin: 7px;
		}

		.axis {
		  font-family: Georgia;
		  font-size: 0.8em;
		}

		path {
		  fill: none;
		  stroke: gray;
		  stroke-width: 1px;
		}

		.tick {
		  fill: none;
		  stroke: black;
		}

		circle {
		  opacity: 1;
		  stroke: none;
		}
		.surv{
		  fill: orange;
		  color: orange;
		  font-weight: bold;
		}
		.died{
		  fill: rgb(100,100,100);
		  color: rgb(100,100,100);
		  font-weight: bold;
		}
		
		circle.surv:hover {
		  fill: orangered;
		}
		circle.died:hover {
		  fill: rgb(0,0,0);
		}
		
		.cir-tip {
		  line-height: 1;
		  font-size: 12px;
		  font-weight: bold;
		  padding: 5px;
		  background: rgba(0, 0, 0, 0.5);
		  color: #fff;
		  border-radius: 10px;
		}

		.bg {
		  opacity: 0.5;
		}
	</style>

    <script type="text/javascript">
      format = d3.time.format("%d-%m-%Y (%H:%M h)");

      function draw(data) {
        "use strict";
        var margin = 50,
            width = 1000 - margin,
            height = 500 - margin,
		    mid = width / 2 + margin;

        var RADIUS = 4;
		var n_c_col = 10;
		
		/* pre-processing */
		data = data.filter(function(d) { 
			return d.Age !== "" && (d.Sex === "male" || d.Sex === "female");
		});
		data.forEach(function(d) { d.Age = +d.Age; });
		
		/* title */
		d3.select("body")
            .append("h2")
            .text("Titanic Passenger Demographics (Partial)");
		
		
		function animate(group_by) { // TODO
		    return;
		} 
		
		
		
		/* buttons for interaction */	
		var button_text = ["Gender", "Ticket Class"];
		var text_to_group = {"Gender": "Sex", "Ticket Class": "Pclass"};
		
		var buttons = d3.select("body")
			.append("table")
			.attr("class", "button")
			.append("tr")
			.selectAll("td")
			.data(button_text)
			.enter()
			.append("td")
			.text(function(d) {
				return d;
			});
		
		buttons.on("click", function(d) {
			d3.select(".button")
			    .selectAll("td")
			    .transition()
			    .duration(200)
				.style("color", "black")
				.style("background", "rgb(251, 201, 127)");

			d3.select(this)
				.transition()
				.duration(200)
				.style("background", "lightBlue")
				.style("color", "white");
				
			animate(text_to_group[d]);
		});
		

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin);		
		
		/* background */
		var g_background = svg.append('g').attr('class', 'background');
		
		g_background.append('rect')
		    .attr('class', 'bg left')
			.attr('x', margin)
			.attr('width', width / 2)
			.attr('y', 0)
			.attr('height', height + margin)
			.style('fill', 'rgb(220, 220, 220)');
			
		g_background.append('rect')
		    .attr('class', 'bg right')
			.attr('x', margin + width / 2)
			.attr('width', width / 2)
			.attr('y', 0)
			.attr('height', height + margin)
			.style('fill', 'lightBlue');
		
		/* subtitle */
		var subtitle = svg.append('g');
		
		subtitle.append('text')
			.attr('class', 'died')
			.attr('x', mid - 2)
			.attr('y', margin / 2)
			.attr('text-anchor', 'end')
			.text('Perished');
			
		subtitle.append('text')
			.attr('class', 'surv')
			.attr('x', mid + 2)
			.attr('y', margin / 2)
			.attr('text-anchor', 'start')
			.text('Survived');
		
        var g_chart = svg.append('g').attr('class', 'chart');
		
		/* scales */
        var count_max = data.length;

        var count_scale_surv = d3.scale.linear()
            .range([mid, width + margin])
            .domain([0, count_max]);
			  
		var count_scale_died = d3.scale.linear()
            .range([mid, margin])
            .domain([0, count_max]);	  
		
		var group_by = "Sex";
/*			  
		var age_max = d3.max(data, function(d) {
		    return d.Age;
		});
			  		  
		var y_scale_perc = d3.scale.quantile()
			.domain([0, age_max])
			.range(d3.range(0, 1000, 125));
*/		  
		var y_scale_ord = d3.scale.ordinal()
			.rangeRoundBands([0, height], .3, .1);
			
        y_scale_ord.domain(data.map(function(d) { 
		    return d[group_by]; 
		}).sort());

		//RADIUS = y_scale_ord.rangeBand() / (2.5 * n_c_col + 0.5); 
		n_c_col = Math.floor((y_scale_ord.rangeBand() / RADIUS - 0.5) / 2.5);
		debugger;
		
		/* Axes */
		var y_axis = d3.svg.axis()
//			.scale(y_scale_perc)
			.scale(y_scale_ord)
			.orient("left");

        svg.append('g')
            .attr('class', 'y axis')
            .attr('transform', 
			      "translate(" + margin + "," + margin + ")")
            .call(y_axis);
		/*	
        var count_axis_surv = d3.svg.axis()
            .scale(count_scale_surv)
            .orient("top");

        svg.append('g')
            .attr('class', 'x axis surv-axis')
            .attr('transform', "translate(0," + margin + ")")
            .call(count_axis_surv);
		
		var count_axis_died = d3.svg.axis()
            .scale(count_scale_died)
            .orient("top");

        svg.append('g')
            .attr('class', 'x axis died-axis')
            .attr('transform', "translate(0," + margin + ")")
            .call(count_axis_died);
		*/
		
		/* Circles */	
        var g_cir = svg.append('g')
		    .attr('class', 'circles')
			.attr('transform', 'translate(0,' + margin + ')');	
		
		var tip = d3.tip()
			.attr('class', 'cir-tip')
			.offset([- 0.5 * RADIUS, 0])
			.html(function(d) { return d.Name; });
		g_cir.call(tip);

		function is_surv(survived) {
			return survived == "1" ? true : false;
		}	
		
		function key_func(d) {
            return d.PassengerId;
        }	

        g_cir.selectAll("circle")
            .data(data, key_func)
            .enter().append("circle")
			.attr('class', function(d) {
			    return is_surv(d.Survived) ? 'surv' : 'died';
			})
			.attr('r', RADIUS)
			.on('mouseover', tip.show)
			.on('mouseout', tip.hide);	

		function draw_circles(g, group_data, group_by, kfunc, y_scale, 
				middle) {
			
			var OFFSET = 1.5 * RADIUS;
			var STEP = 2.5 * RADIUS;
			
			function get_cx(d, i) {
			    if (is_surv(d.Survived)) {
				    return middle + (OFFSET + Math.floor(i / n_c_col) * STEP);
				} else {
					return middle - (OFFSET + Math.floor(i / n_c_col) * STEP);
				}
			}
				
			function get_cy(d, i) {
			    return y_scale(d[group_by]) + OFFSET + (i % n_c_col) * STEP;
			}
			
			g.selectAll("circle")
				.data(group_data, kfunc)
//			    .data(group_data.sort(function(a, b) {
//				    return +a.Name - +b.Name;
//				}), kfunc)
				.transition()
				.attr('cx', get_cx)
				.attr('cy', get_cy);
		}
		
		
		var nested = d3.nest()
			.key(function(d) { return d['Survived']; })
		    .key(function(d) { return d[group_by]; })
			.entries(data)
	
		debugger;	
		for (var i = 0; i <= 1; i++) {
		    //var survived = nested[i].key;
			for (var j = 0; j < nested[i].values.length; j++) {
				draw_circles(g_cir, nested[i].values[j].values, group_by, 
						key_func, y_scale_ord, mid);
			}
		}

		/* d3 nest for Bars 
		nested = d3.nest()
		    .key(function(d) {
			    return d[group_by];
			})
			.rollup(function(leaves) {
			    var survived = leaves.filter(function(d) {
					return d.Survived == "1";
				});
				
				return {
				    "survived": survived.length,
					"died": leaves.length - survived.length
				};
			})
			.entries(data)
		
		debugger;
		
		g_chart.selectAll("bar")
			.data(nested)
			.enter().append("rect")
			.style("fill", "rgb(250, 200, 100)")
			.style('opacity', '0.3')
			.attr("y", function(d) { 
			    return y_scale_ord(d.key); 
			})
			.attr("height", y_scale_ord.rangeBand())
			.attr("x", function(d) { 
			    return count_scale_died(d.values['died'])
			})
			.attr("width", function(d) { 
			    return count_scale_surv(d.values['survived']) 
					- count_scale_died(d.values['died']);
			})
			.attr("transform", "translate(0," + margin + ")");
		*/	
      };
    </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 (not dimple.js) to load the TSV file
    and pass the contents of it to the draw function
    */
  d3.csv("titanic_data.csv", draw);
  </script>
</body>
</html>